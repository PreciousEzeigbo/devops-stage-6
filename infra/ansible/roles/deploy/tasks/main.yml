---
# tasks file for deploy
- name: Check if repository exists
  stat:
    path: "{{ app_directory }}/.git"
  register: git_repo

- name: Clone application repository
  git:
    repo: "{{ github_repo }}"
    dest: "{{ app_directory }}"
    version: "{{ github_branch }}"
    force: yes
  when: not git_repo.stat.exists

- name: Pull latest changes from repository
  git:
    repo: "{{ github_repo }}"
    dest: "{{ app_directory }}"
    version: "{{ github_branch }}"
    force: yes
  when: git_repo.stat.exists
  register: git_pull

- name: Generate htpasswd for Traefik dashboard
  shell: |
    echo $(htpasswd -nb {{ traefik_dashboard_user | default('admin') }} {{ traefik_dashboard_password | default('admin') }}) | sed -e s/\\$/\\$\\$/g
  register: traefik_htpasswd
  changed_when: false
  no_log: true

- name: Create .env file for docker-compose
  template:
    src: env.j2
    dest: "{{ app_directory }}/.env"
    mode: '0600'
  register: env_file

- name: Set config changed flag
  set_fact:
    config_changed: "{{ env_file.changed or (git_pull is defined and git_pull.changed) }}"

- name: Copy docker-compose.yml to server
  copy:
    src: ../../../../docker-compose.yml
    dest: "{{ app_directory }}/docker-compose.yml"
    mode: '0644'

- name: Stop existing containers if configuration changed
  command: docker compose down --remove-orphans
  args:
    chdir: "{{ app_directory }}"
  when: config_changed
  ignore_errors: yes

- name: Remove any conflicting containers
  shell: docker ps -a --format '{{{{.Names}}}}' | grep -E '(traefik|devops-stage-6)' | xargs -r docker rm -f
  ignore_errors: yes

- name: Pull Docker images
  command: docker compose pull
  args:
    chdir: "{{ app_directory }}"
  register: docker_pull

- name: Build Docker images
  command: docker compose build
  args:
    chdir: "{{ app_directory }}"
  register: docker_build

- name: Start Docker containers
  command: docker compose up -d
  args:
    chdir: "{{ app_directory }}"
  register: docker_up

- name: Wait for services to be healthy
  wait_for:
    host: localhost
    port: 443
    delay: 10
    timeout: 300
    state: started

- name: Display deployment status
  debug:
    msg: 
      - "Deployment completed successfully!"
      - "Application URL: https://{{ domain }}"
      - "Traefik Dashboard: https://traefik.{{ domain }}"
